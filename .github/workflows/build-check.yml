name: macOS Build Check

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_14.3.app

      - name: Build the app (Release Configuration)
        run: |
          xcodebuild clean build \
          -project NeoPaste.xcodeproj \
          -scheme NeoPaste \
          -sdk macosx \
          -configuration Release \
          -derivedDataPath build

      - name: Verify the build
        run: test -d build || echo "Build directory not found!"

      - name: Archive the app
        if: success()
        run: |
          xcodebuild archive \
          -project NeoPaste.xcodeproj \
          -scheme NeoPaste \
          -archivePath build/NeoPaste.xcarchive

      - name: Upload Archive
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: neospaste-archive
          path: build/NeoPaste.xcarchive

      - name: Export the archive
        if: success()
        run: |
          xcodebuild -exportArchive \
          -archivePath build/NeoPaste.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/exported-app

      - name: Upload Exported App
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: neospaste-exported-app
          path: build/exported-app
